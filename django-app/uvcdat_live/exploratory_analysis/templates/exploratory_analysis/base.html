{% load staticfiles %}

<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    
    <link rel="shortcut icon" href="./ico/favicon.png">


    <title>UV-CDAT+ Prototype</title>

<!-- 
	<link type="text/css" href="{% static 'exploratory_analysis/css/style.css' %}" rel="stylesheet" />
 -->
 	
	<!-- Bootstrap core CSS -->
	<link href="{% static 'exploratory_analysis/css/bootstrap.css' %}" rel="stylesheet" />
	
	<link href="{% static 'exploratory_analysis/css/sticky-footer-navbar.css' %}" rel="stylesheet" />
	<link href="{% static 'exploratory_analysis/css/navbar-fixed-top.css' %}" rel="stylesheet" />
	<link href="{% static 'exploratory_analysis/css/grid.css' %}" rel="stylesheet" />
	
	<link href="{% static 'exploratory_analysis/css/tree/style.css' %}" rel="stylesheet" />

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-39778348-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        
        
    </script>
    
    <style type="text/css">



		html {
			overflow-y: scroll;
		}
		
		.node circle {
		  cursor: pointer;
		  fill: #fff;
		  stroke: steelblue;
		  stroke-width: 1.5px;
		}
		
		.node text {
		  font-size: 11px;
		}
		
		path.link {
		  fill: none;
		  stroke: #ccc;
		  stroke-width: 1.5px;
		}

    </style>

</head>

<!--
{% if latest_poll_list %}
  <ul>
  {% for poll in latest_poll_list %}
    <li><a href="/polls/{{poll.id}}/">{{poll.question}}</a></li>
  {% endfor %}
  </ul>
{% else %}
  <p class="greentext">No polls are available.</p>
{% endif %}
-->
<body>

<!-- <div class="greentext">index.htm </div> -->

<!-- Wrap all page content here -->
    <div id="wrap">

<!-- Fixed navbar -->
		<div class="navbar navbar-inverse navbar-fixed-top">

			<div class="container">
          		<div class="navbar-header">
            		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              		<span class="icon-bar"></span>
              		<span class="icon-bar"></span>
              		<span class="icon-bar"></span>
            		</button>
            		<a class="navbar-brand" href="#">UV-CDAT+</a>
          		</div>
          		
          		<div class="collapse navbar-collapse">

            		<ul class="nav navbar-nav">

	                	<li class="active"><a href="http://localhost:8081/exploratory_analysis">Home</a></li>
			                
			            <!--  
						<li class="dropdown">
	               			<a href="#" class="dropdown-toggle" data-toggle="dropdown">CLM Variables<b class="caret"></b></a>
	               			<ul class="dropdown-menu">
			                    <li><a href="all.html">All</a></li>
			                    <li class="menu" id="AR"><a href="#" >AR</a></li>
			                    <li class="menu" id="BTRAN"><a href="#">BTRAN</a></li>
			                    <li class="menu" id="CWDC"><a href="#">CWDC</a></li>
			                    <li class="menu" id="DEADCROOTC"><a href="#">DEADCROOTC</a></li>
			                    <li class="menu" id="DEADSTEMC"><a href="#">DEADSTEMC</a></li>
			                    <li class="menu" id="ER"><a href="#">ER</a></li>
			                    <li class="menu" id="FROOTC"><a href="#">FROOTC</a></li>
			                    <li class="menu" id="FSDS"><a href="#">FSDS</a></li>
			                    <li class="menu" id="GPP"><a href="#">GPP</a></li>
			                    <li class="menu" id="HR"><a href="#">HR</a></li>
			                    <li class="menu" id="LIVECROOTC"><a href="#">LIVECROOTC</a></li>
			                    <li class="menu" id="LIVESTEMC"><a href="#">LIVESTEMC</a></li>
			                    <li class="menu" id="NEE"><a href="#">NEE</a></li>
			                    <li class="menu" id="NPP"><a href="#">NPP</a></li>
			                    <li class="menu" id="PCO2"><a href="#">PCO2</a></li>
			                    <li class="menu" id="RAIN"><a href="#">RAIN</a></li>
			                    <li class="menu" id="TBOT"><a href="#">TBOT</a></li>
			                    <li class="menu" id="TLAI"><a href="#">TLAI</a></li>
			                    <li class="menu" id="TOTECOSYSC"><a href="#">TOTECOSYSC</a></li>
			                    <li class="menu" id="TOTLITC"><a href="#">TOTLITC</a></li>
			                    <li class="menu" id="TOTSOMC"><a href="#">TOTSOMC</a></li>
			                    <li class="menu" id="TOTVEGC"><a href="#">TOTVEGC</a></li>
			                    <li class="menu" id="WOODC"><a href="#">WOODC</a></li>
			                    
	               			</ul>
	               		</li>
						-->
						
						<li><a href="http://localhost:8081/exploratory_analysis/maps">Geo</a></li>
						<li><a href="http://localhost:8081/exploratory_analysis/tree">Diags Tree</a></li>
			            
            		</ul>


        		</div>

        	</div>

		</div>

		

		<div id="content">
        {% block content %}{% endblock %}
    	</div>


  	</div>


 
 <!--  
   	<div id="footer">
     	<div class="container">
         	<p class="text-muted credit"><a href="http://cda.ornl.gov/steed/personal/">Chad A.&nbspSteed</a>, Oak Ridge National Lab, Computational Sciences and Engineering Division.</p>
     	</div>
   	</div>
-->

	
	<script src="{% static 'exploratory_analysis/js/jquery/jquery-1.10.2.min.js' %}"></script>
	<script src="{% static 'exploratory_analysis/js/bootstrap/bootstrap.min.js' %}"></script>
	<script src="{% static 'exploratory_analysis/js/bootstrap/bootstrap-combobox.js' %}"></script>
	

	<script src="http://d3js.org/d3.v2.min.js?2.9.6"></script>
	<script type="text/javascript" src="{% static 'exploratory_analysis/js/geo/map.js' %}"></script>
	
    <!--<script type="text/javascript" src="d3.v3/d3.v3.js"></script>-->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    
	
	<script type="text/javascript">
	
	
	$(document).ready(function(){
		
		var jsonData = '';
		var queryString = '';
		var url = 'datasets/' + 'jfharney';
		
		console.log('querying: ' + url);

		$.ajax({
			url: url,
			global: false,
			type: 'GET',
			dataType: 'json',
			data: queryString,
			success: function(data) {
				
				var datasetList = data['datasets'];
				$('#dataset_name').empty();
				for (var i=0;i<datasetList.length;i++) {
					var dataset = datasetList[i];
					$('.dropdown-dataset-menu').append('<li class="dataset_menu" id="' + dataset + '"><a href="#">' + dataset + '</a></li>');
				}
				
			},
			error: function( jqXHR, textStatus, errorThrown ) {
				alert('datasets textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
				
			}
		});
		
		
		$('#viz_button').click(function() {

			console.log('dataset id: ' + $('span#dataset_name').html());
			console.log('variable id: ' + $('span#variable_name').html());
			console.log('time id: ' + $('span#time_name').html());
			
			var variable_id = $('span#variable_name').html();
			
			if(variable_id == '' || variable_id == ' ' || variable_id == 'undefined') {
				variable_id = 'AR';
			}
			
			var url = 'visualizations?variable=' + variable_id;
			
			$.ajax({
				url: url,
				global: false,
				type: 'GET',
				dataType: 'json',
				data: queryString,
				success: function(data) {
					
					//console.log('data: ' + data);
					$('.page-header').empty();
					$('.lead').empty();
					$('#map-canvas').empty();

                                        mapdata = JSON.parse(data);
					create_map_canvas(mapdata, "#map-canvas", 720, 360);
					
					$('.page-header').append('<h3>' + variable_id  + 'Average Map</h3>');
					$('#map-canvas').append('<div>Data for: ' + variable_id + '</div>');
					//$('#map-canvas').append('<div>' + data + '</div>');
					
					
				},
				error: function( jqXHR, textStatus, errorThrown ) {
					alert('vizualizations textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
					
				}
			});
			
			
		});
		
		
		$('.dropdown-dataset-menu').on('click','a',function() {
			//alert('issue an ajax call for variables for dataset ' + this.innerHTML);
			
			var jsonData = '';
			var queryString = '';
			var url = 'variables/' + this.innerHTML;
			
			console.log('querying: ' + url);
			
			
			$.ajax({
				url: url,
				global: false,
				type: 'GET',
				dataType: 'json',
				data: queryString,
				success: function(data) {
					
					for(var key in data) {
						console.log('key: ' + key + ' ' + data[key]);
					}
					
					var variableList = data['variables'];
					$('.dropdown-variable-menu').empty();
					
					console.log(variableList);
					for (var i=0;i<variableList.length;i++) {
						var variable = variableList[i];
						console.log('variable: ' + variable);
						$('.dropdown-variable-menu').append('<li class="variable_menu" id="' + variable + '"><a href="#">' + variable + '</a></li>');
					}
					
					$('#dropdown-variable-container').show();

					
				},
				error: function( jqXHR, textStatus, errorThrown ) {
					alert('variables textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
					
				}
			});

			$('#dataset_name').empty();
			$('#dataset_name').append(this.innerHTML);
			
		});
		
		$('.dropdown-variable-menu').on('click','a',function() {
			//alert('issue an ajax call for variables for dataset ' + this.innerHTML);
			
			console.log('find times ' + this.innerHTML);
			
			var jsonData = '';
			var queryString = '';
			var url = 'times/' + this.innerHTML;
			
			console.log('querying: ' + url);
			
			
			$.ajax({
				url: url,
				global: false,
				type: 'GET',
				dataType: 'json',
				data: queryString,
				success: function(data) {
					
					for(var key in data) {
						console.log('key: ' + key + ' ' + data[key]);
					}
					
					var timeList = data['times'];
					$('.dropdown-time-menu').empty();
					
					console.log(timeList);
					for (var i=0;i<timeList.length;i++) {
						var time = timeList[i];
						console.log('time: ' + time);
						$('.dropdown-time-menu').append('<li class="time_menu" id="' + time + '"><a href="#">' + time + '</a></li>');
					}
					
					$('#dropdown-time-container').show();

					
				},
				error: function( jqXHR, textStatus, errorThrown ) {
					alert('time textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
					
				}
			});

			$('#variable_name').empty();
			$('#variable_name').append(this.innerHTML);
			
		});
		
		
		$('.dropdown-time-menu').on('click','a',function() {


			$('#time_name').empty();
			$('#time_name').append(this.innerHTML);
		
		});
		
		

		$('li.menu').on('click', function() {
			var jsonData = '';
			var queryString = '';
			var $input = $( this );
			var variable = $input.attr("id");
	
			var url = 'visualizations?variable=' + variable;
			
			$.ajax({
				url: url,
				global: false,
				type: 'GET',
				dataType: 'json',
				data: queryString,
				success: function(data) {
					
					//console.log('data: ' + data);
					$('.page-header').empty();
					$('.lead').empty();
					$('#map-canvas').empty();
					
					create_map_canvas(data, "#map-canvas", 720, 360);
					
					$('.page-header').append('<h3>' + variable  + 'Average Map</h3>');
					$('#map-canvas').append('<div>Data for: ' + variable + '</div>');
					//$('#map-canvas').append('<div>' + data + '</div>');
					
					
				},
				error: function( jqXHR, textStatus, errorThrown ) {
					alert('vizssss textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
					
				}
			});
		});
	
		
		
		
		
	    
		// max number of images to display simultaneously.
		var MAX_CANVAS = 4;

		var m = [20, 120, 20, 120],
		    w = 1280 - m[1] - m[3],
		    h = 800 - m[0] - m[2],
		    i = 0,
		    canvasData = [],
		    root;

		var tree = d3.layout.tree()
		    .size([h, w]);

		var diagonal = d3.svg.diagonal()
		    .projection(function(d) { return [d.y, d.x]; });

		var vis = d3.select("#body").append("svg:svg")
		    .attr("width", w + m[1] + m[3])
		    .attr("height", h + m[0] + m[2])
		  .append("svg:g")
		    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");


		var queryString = '';
		var url = 'treedata/' + 'jfharney';

		$.ajax({
			url: url,
			global: false,
			type: 'GET',
			dataType: 'json',
			data: queryString,
			success: function(data) {
				
				for (var key in data) {
					console.log('key: ' + key);
				}
				
				callD3(data);
				/*
				var datasetList = data['datasets'];
				$('#dataset_name').empty();
				for (var i=0;i<datasetList.length;i++) {
					var dataset = datasetList[i];
					$('.dropdown-dataset-menu').append('<li class="dataset_menu" id="' + dataset + '"><a href="#">' + dataset + '</a></li>');
				}
				*/
			},
			error: function( jqXHR, textStatus, errorThrown ) {
				alert('tree data textStatus: ' + textStatus + ' errorThrown: ' + errorThrown);
				
			}
		});




		function callD3(data) {
			
			console.log('calling d3');
			
			//var jsonData = JSON.parse(data);
		//mapdata = JSON.parse(json_datafile);

			  json = data;
			  console.log(json);
		/*	d3.json(data, function(json) { */
			
			  root = json;
			  root.x0 = h / 2;
			  root.y0 = 0;
			
			  function toggleAll(d) {
				  console.log('in toggle all for ' + d);
			    if (d.children) {
			      d.children.forEach(toggleAll);
			      toggle(d);
			    }
			  }
			
			  for(var key in root) {
				  console.log('rootkey: ' + key);
			  }
			  
			  // Initialize the display to show a few nodes.
			  root.children.forEach(toggleAll);
			  
			  /*
			  toggle(root.children[1]);
			  toggle(root.children[1].children[2]);
			  toggle(root.children[9]);
			  toggle(root.children[9].children[0]);
				*/
			  update(root);
			  
			  
//			});
		}

		function update(source) {
		  var duration = d3.event && d3.event.altKey ? 5000 : 500;

		  // Compute the new tree layout.
		  var nodes = tree.nodes(root).reverse();

		  // Normalize for fixed-depth.
		  nodes.forEach(function(d) { d.y = d.depth * 180; });

		  // Update the nodes…
		  var node = vis.selectAll("g.node")
		      .data(nodes, function(d) { return d.id || (d.id = ++i); });

		  // Enter any new nodes at the parent's previous position.
		  var nodeEnter = node.enter().append("svg:g")
		      .attr("class", "node")
		      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
		      .on("click", function(d) { toggle(d); update(d); });

		  nodeEnter.append("svg:circle")
		      .attr("r", 1e-6)
		      .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		  nodeEnter.append("svg:a")
		      //.attr("xlink:href", function(d){return d.url})
		    .append("svg:text")
		  //nodeEnter.append("svg:text")
		      .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
		      .attr("dy", ".35em")
		      .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
		      .text(function(d) { return d.name; })
		      .style("fill-opacity", 1e-6)
		      .on("click", function(d) {if(d.url){addImage(d.url)}});

		  // Transition nodes to their new position.
		  var nodeUpdate = node.transition()
		      .duration(duration)
		      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

		  nodeUpdate.select("circle")
		      .attr("r", 4.5)
		      .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

		  nodeUpdate.select("text")
		      .style("fill-opacity", 1);

		  // Transition exiting nodes to the parent's new position.
		  var nodeExit = node.exit().transition()
		      .duration(duration)
		      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
		      .remove();

		  nodeExit.select("circle")
		      .attr("r", 1e-6);

		  nodeExit.select("text")
		      .style("fill-opacity", 1e-6);

		  // Update the links…
		  var link = vis.selectAll("path.link")
		      .data(tree.links(nodes), function(d) { return d.target.id; });

		  // Enter any new links at the parent's previous position.
		  link.enter().insert("svg:path", "g")
		      .attr("class", "link")
		      .attr("d", function(d) {
		        var o = {x: source.x0, y: source.y0};
		        return diagonal({source: o, target: o});
		      })
		    .transition()
		      .duration(duration)
		      .attr("d", diagonal);

		  // Transition links to their new position.
		  link.transition()
		      .duration(duration)
		      .attr("d", diagonal);

		  // Transition exiting nodes to the parent's new position.
		  link.exit().transition()
		      .duration(duration)
		      .attr("d", function(d) {
		        var o = {x: source.x, y: source.y};
		        return diagonal({source: o, target: o});
		      })
		      .remove();

		  // Stash the old positions for transition.
		  nodes.forEach(function(d) {
		    d.x0 = d.x;
		    d.y0 = d.y;
		  });
		}



		// Toggle children.
		function toggle(d) {
		  if (d.children) {
		    d._children = d.children;
		    d.children = null;
		  } else {
		    d.children = d._children;
		    d._children = null;
		  }
		}

		function addImage(dataURL) {
			var i;
			var canvas = document.getElementById("image_canvas");
			var context = canvas.getContext('2d');
			context.clearRect(0, 0, 1800, 1000);
			canvasData.push(dataURL);
			if(canvasData.length > MAX_CANVAS) {
				canvasData.shift();
			}
			
			for(i = 0; i < canvasData.length; i++) {
			   drawImage(context, i);
			}
		}

		function drawImage(context, i) {
			var imageObj = new Image();
		    imageObj.onload = function() {
		      context.drawImage(this, 450 * i, 0);
		    };

		    imageObj.src = canvasData[i];
		}

		
		
		

});


	</script>


</body>


</html>


